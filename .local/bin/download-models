#!/bin/sh

# Download additional models for Stable Diffusion

# Add a CivitAI token
token=$1

# Pretty print
delimiter="################################################################"

function downloadModel {
	# Downloads Stable Diffusion models to a specified location
	dir=$1 # Current directory
	folder=$2 # Download folder for models
	token=$3 # CivitAI token
	shift 3 # Delete first 3 values from function's input array
	versionID=$@ # Array of model version ID's to download

	# Create a folder to download models, if it doesn't exist
	if ! [ -d $folder ]; then
		mkdir -p $folder
	fi
	cd $folder

	# Download selected models
	for id in ${versionID[@]}; do
		# Get the ID of a base model from it's version ID
		modelID=$(curl -s https://civitai.com/model-versions/${id} | cut -d "/" -f 3 | cut -d "?" -f 1)

		# Get names of the files associated with the model
		files=$(curl -s https://civitai.com/api/v1/models/${modelID} | jq ".modelVersions[]|select(.id==${id}).files[].name")

		# Get URLs for files of the model
		urls=$(curl -s https://civitai.com/api/v1/models/${modelID} | jq ".modelVersions[]|select(.id==${id}).files[].downloadUrl")

		# Create array of filenames
		while read -r file; do
			# Remove whitespace
			file=$(echo ${file} | sed 's/ //g')
			files_array+=(${file})
		done <<< ${files}

		# Create array of urls
		while read -r url; do
			urls_array+=(${url})
		done <<< ${urls}

		# Download models
		for (( i=0; i<${#urls_array[@]}; i++)); do
			name=$(echo ${files_array[${i}]} | tr -d "\"")
			url=$(echo ${urls_array[$i]} | tr -d "\"")
			printf "\n%s\n" "${delimiter}"
			# Skip model if it's already downloaded
			if [ -f ${name} ]; then
				printf "File ${name} already exists\n"
			else
				printf "Downloading ${name}\n"
				if [[ $(curl -s ${url}) == "{\"error\":\"Unauthorized\",\"message\":\"The creator of this asset requires you to be logged in to download it\"}" ]]; then
					curl -o ${name} -L -H "Content-Type: application/json" -H "Authorization: Bearer ${token}" ${url}
				else
					url=$(curl -s ${url})
					curl -o ${name} ${url}
				fi
			fi
		done

		# Unset arrays
		unset files_array
		unset urls_array
	done

	# Go back to original directory
	cd $dir
}

# Download Embeddings
printf "\n%s\n" "${delimiter}"
printf "Downloading Embeddings"
printf "\n%s\n" "${delimiter}"
embeddings=(82745 509253 482268)
downloadModel $PWD "embeddings/" $token ${embeddings[@]}

# Download Lora models
printf "\n%s\n" "${delimiter}"
printf "Downloading Lora models"
printf "\n%s\n" "${delimiter}"
models=(135867 319697 116354 33381 509253 482268 165259 165424)
downloadModel $PWD "models/Lora/" $token ${models[@]}

# Download Checkpoints
printf "\n%s\n" "${delimiter}"
printf "Downloading Checkpoint models"
printf "\n%s\n" "${delimiter}"
models=(511677 429454 361593 627807 495273)
downloadModel $PWD "models/Stable-diffusion/" $token ${models[@]}
