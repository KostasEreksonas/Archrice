#!/bin/sh

# Convert all video files in a given directory
# Dependencies: ffmpeg

# Check if ffmpeg is installed
ffmpeg -version 2>/dev/null 1>&2
if [[ ${?} != 0 ]]; then
        echo "[+] Package "ffmpeg" is not installed. Terminating script" && exit 1
fi

# Check if exiftool is installed
exiftool -ver 2>/dev/null 1>&2
if [[ ${?} != 0 ]]; then
        echo "[+] Package "exiftool" is not installed. Terminating script" && exit 1
fi

# Choose an encoder
if [ -z ${enc} ]; then
	PS3="[+] Choose encoder: "
	encoders=("libx264" "libx265")
	select encoder in ${encoders[@]}; do
		case ${encoder} in
			"libx264")
				enc=${encoder}
				break
				;;
			"libx265")
				enc=${encoder}
				break
				;;
			*)
				echo "[+] No such option ${REPLY}"
				;;
		esac
	done
fi

# Print encoder
printf "[+] Encoder: ${enc}\n"

function setParameters {
	# Set parameters for ffmpeg
	audio_default=${1}
	crf_default=${2}

	# Set audio parameter value
	read -p "[+] Choose audio settings (default: ${audio_default}): " audio
	if [ -z ${audio} ]; then audio="${audio:-${audio_default}}"; fi
	printf "[+] Audio: ${audio}\n"

	# Set preset parameter value
	#read -p "[+] Choose ffmpeg preset (default: ${preset_default}): " preset
	#if [ -z ${preset} ]; then preset="${preset:-${preset_default}}"; fi
	PS3="[+] Choose preset: "
	values=("ultrafast" "superfast" "veryfast" "faster" "fast" "medium" "slow" "slower" "veryslow" "placebo")
	select value in ${values[@]}; do
		case ${value} in
			"ultrafast")
				preset=${value}
				break
				;;
			"superfast")
				preset=${value}
				break
				;;
			"veryfast")
				preset=${value}
				break
				;;
			"faster")
				preset=${value}
				break
				;;
			"fast")
				preset=${value}
				break
				;;
			"medium")
				preset=${value}
				break
				;;
			"slow")
				preset=${value}
				break
				;;
			"slower")
				preset=${value}
				break
				;;
			"veryslow")
				preset=${value}
				break
				;;
			"placebo")
				preset=${value}
				break
				;;
			*)
				printf "[+] No such option ${REPLY}\n"
				;;
		esac
	done

	printf "[+] Preset: ${preset}\n"

	# Set crf parameter value
	while ! [[ ${crf} =~ [0-9] && ${crf} -ge 0 && ${crf} -le 53 ]]; do
        read -p "[+] Choose CRF value (0-53, defult: ${crf_default}): " crf
        if [ -z ${crf} ]; then crf="${crf:-${crf_default}}"; fi
        if [[ ${crf} -lt 0 || ${crf} -gt 53 ]]; then
                printf "[+] Please enter a crf value between 0 - 53\n"
        fi
	done
	printf "[+] Crf: ${crf}\n"
}

if [ ${enc} == "libx264" ]; then
	# Set parameters for libx264
	setParameters "copy" "17"
elif [ ${enc} == "libx265" ]; then
	# Set parameters for libx265
	setParameters "copy" "18"
fi

if [ -z ${ext} ]; then
	# Choose a file extension to convert to
	PS3="[+] Choose file extension to convert to: "
	extensions=("mkv" "mp4" "webm" "avi" "mov" "m4v" "wmv")
	select extension in ${extensions[@]}; do
		case ${extension} in
			"mp4")
				ext=${extension}
				break
				;;
			"mkv")
				ext=${extension}
				break
				;;
			"webm")
				ext=${extension}
				break
				;;
			"avi")
				ext=${extension}
				break
				;;
			*)
				printf "[+] No such option ${REPLY}\n"
				;;
		esac
	done
fi

# Print extension
printf "[+] Extension to convert: ${ext}\n"


# Remove special characters from filenames and replace whitespaces with underscores
$(update-filename)

# Encode all video files
for f in *; do
	# Get files in current directory
	if [[ -f ${f} ]] && [[ ${f} =~ [A-Za-z0-9_\(\)]\.[A-Za-z0-9]+{3,4} ]]; then
		# Split filename
		name=${f%%.*} # Get file name
		ext_orig=${f##*.} # Get file extension
		ext_orig=$(echo ${ext_orig} | tr '[:upper:]' '[:lower:]') # Convert extension to lowercase

		# Check if current directory already has a converted video file with the same filename
		c=0 # Set to 1 if a file is already converted
		for conv in *_conv*; do
			# Check if directory has any filenames with _conv suffix
			if ! [[ ${conv} == "*_conv*" ]]; then
				if [[ ${name} == ${conv%%_conv*} ]]; then
					printf "[+] File ${f} is already converted and saved as ${conv}\n"
					c=1
				fi
			fi
		done

		# Check if a video is already converted
		if [[ ${name} =~ (_conv)$ ]]; then
			printf "[+] File ${f} is already converted\n"
			c=1
		fi

		# Check if the file is a video file of a supported format
		if ! [[ ${extensions[@]} =~ ${ext_orig} ]]; then
			printf "[+] \"${f}\" is not a video file / unsupported extension \"${ext_orig}\"\n"
			c=1
		fi

		# Check if file is already encoded using the same encoder
		if [[ ${c} == 0 ]]; then
			current_encoding=$(exiftool ${f} | grep -E 'Encoding|Encoder' | cut -d ":" -f 2 | cut -d " " -f 3)
			if [[ ${current_encoding} == ${enc} ]]; then
				printf "[+] The video ${f} is already encoded with ${enc}\n"
				c=1
			fi
		fi

		# If all checks are passed, convert the video file
		if [[ ${c} == 0 ]]; then
			printf "[+] Converting ${f} to ${name}_conv.${ext}\n"
			ffmpeg -i ${f} -c:a ${audio} -c:v ${enc} -preset ${preset} -crf ${crf} ${name}"_conv".${ext}
		fi
	fi
done

# Remove "_conv" suffix from filenames (optional)
while true; do
	read -p "[+] Do you want to remove \"_conv\" suffix from the converted files? [Y/N] " choice
	if [[ "${choice}" == "Y" || "${choice}" == "y" ]]; then
		for f in *_conv*; do
			if [ ${f} == "*_conv*" ]; then
				printf "No files to rename\n"
			else
				ext=${f##*.}
				mv "${f}" "${f/_conv.${ext}/.${ext}}"
			fi
		done
		break
	elif [[ "${choice}" == "N" || "${choice}" == "n" ]]; then
		break
	fi
done
